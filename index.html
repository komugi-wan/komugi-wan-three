<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Animate & Gamers Favorite Panel</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#e5989b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <link rel="apple-touch-icon" href="icon-512.png">

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('SW registered'))
            .catch(err => console.error('SW failed', err));
        });
      }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;500&family=Quicksand:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* 大人可愛いピンク系カラーパレットへの変更 */
            --primary-bg: #fff9f9;
            --accent-color: #e5989b; /* 落ち着いたダスティピンク */
            --accent-soft: #f4dada;
            --text-main: #6d5959; /* 少し赤みのあるグレーブラウン */
            --text-sub: #b5a4a4;
            --card-bg: #ffffff;
            --delete-hover: #ffb4b4;
            --animate-soft: #e6f0fa;
            --gamers-soft: #fff5e6;
            --overlay-bg: rgba(109, 89, 89, 0.4);
            --border-color: #f7eded;
        }

        body { 
            font-family: 'Quicksand', 'Noto Sans JP', sans-serif;
            background-color: var(--primary-bg); 
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            letter-spacing: 0.03em;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            overscroll-behavior-y: none; /* バウンス抑制 */
        }

        .container { 
            max-width: 480px;
            margin: auto; 
            background: var(--card-bg); 
            padding: 30px; 
            border-radius: 24px; 
            box-shadow: 0 10px 30px rgba(229, 152, 155, 0.15);
        }

        h2 { font-size: 1.4rem; margin-bottom: 8px; color: var(--accent-color); font-weight: 500; }
        .label { font-size: 12px; color: var(--text-sub); margin-bottom: 25px; }

        .section-title {
            font-size: 0.9rem; color: var(--text-sub); margin: 25px 0 10px;
            border-bottom: 1px solid var(--border-color); padding-bottom: 5px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .input-group { 
            display: flex; gap: 12px; background: #fffcfc;
            padding: 6px; border-radius: 12px; border: 1px solid var(--border-color);
        }

        .input-controls, .wish-controls { display: flex; gap: 8px; margin: 8px 0 15px; }

        /* iOSでのズーム防止のためフォントサイズを16px以上に調整、またはscale調整 */
        input[type="text"], select { 
            flex: 1; padding: 12px 15px; border: none; background: transparent;
            outline: none; font-size: 16px; color: var(--text-main);
            user-select: text; -webkit-user-select: text;
        }

        select { 
            background: #fffcfc; border: 1px solid var(--border-color); border-radius: 8px; 
            font-size: 0.85rem; cursor: pointer; appearance: none;
        }

        .add-btn { 
            background: var(--accent-color); color: white; border: none; 
            padding: 0 20px; border-radius: 8px; cursor: pointer; 
            font-size: 14px; transition: all 0.2s; white-space: nowrap;
            touch-action: manipulation;
        }
        .add-btn.wish { background: var(--text-sub); }
        .add-btn.sub { background: var(--accent-soft); color: var(--text-main); font-size: 11px; padding: 4px 10px; }
        .add-btn:active { transform: scale(0.95); opacity: 0.8; }
        .add-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }

        .panel-list { display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 15px; }

        .wish-tabs, .group-tabs {
            display: flex; gap: 5px; margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto; white-space: nowrap;
            -webkit-overflow-scrolling: touch; /* スムーズスクロール */
            padding-bottom: 5px; /* スクロールバー用余白 */
        }

        .wish-tab, .group-tab {
            flex: 1; padding: 8px 5px; font-size: 0.75rem; text-align: center;
            cursor: pointer; border-radius: 8px 8px 0 0; color: var(--text-sub);
            transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 2px;
            min-width: 60px; /* タップしやすく */
        }

        .wish-tab:active, .group-tab:active { background: #fff5f5; }

        .wish-tab.active, .group-tab.active {
            background: var(--primary-bg); color: var(--text-main);
            font-weight: bold; border-bottom: 2px solid var(--accent-color);
        }

        .tab-badge { font-size: 10px; background: #f0eded; padding: 1px 6px; border-radius: 10px; }
        .active .tab-badge { background: var(--accent-color); color: white; }

        /* タグチップ用のスタイル */
        .filter-tags-container, .modal-tags-container {
            display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;
        }
        .tag-chip {
            padding: 4px 12px; border-radius: 20px; background: #fdf0f0;
            font-size: 11px; color: var(--text-sub); cursor: pointer;
            transition: all 0.2s; border: 1px solid transparent;
        }
        .tag-chip.active {
            background: var(--accent-color); color: white;
            box-shadow: 0 2px 8px rgba(229, 152, 155, 0.3);
        }
        .modal-tag-chip {
            padding: 4px 10px; border-radius: 6px; background: #f7eded;
            font-size: 10px; color: var(--text-main); cursor: pointer;
        }

        #wish-list.panel-list { 
            display: flex !important;
            flex-direction: column !important; /* 縦に並べる */
            gap: 16px; /* アイテム間の余白を少し広げる */
        }

        .panel-item { 
            display: flex; align-items: center; background: #fff;
            border: 1px solid var(--border-color); border-radius: 12px;
            transition: transform 0.1s ease, box-shadow 0.2s ease; overflow: hidden;
            touch-action: pan-y; /* 横スクロール無効、縦スクロール有効 */
        }
        
        .panel-item:active {
            transform: scale(0.98);
            background-color: #fffafa;
        }
        
        #wish-list .panel-item {
            position: relative;
            flex-direction: row; /* 画像とテキストを横に並べる場合 */
            width: 100% !important;
            height: 120px; /* 高さを固定してコンパクトに */
            aspect-ratio: auto; /* 比率固定を解除 */
        }

        .shop-btn {
            display: flex; align-items: center; justify-content: center;
            width: 44px; height: 44px; text-decoration: none;
            -webkit-tap-highlight-color: rgba(0,0,0,0.05);
        }

        .color-dot { width: 14px; height: 14px; border-radius: 50%; }
        .dot-animate { background-color: var(--animate-soft); }
        .dot-gamers { background-color: var(--gamers-soft); }

        .keyword-display {
            flex: 1; padding: 12px 15px; font-size: 0.95rem; font-weight: 500;
            cursor: pointer;
            /* ロングプレス時のメニュー抑制 */
            -webkit-touch-callout: none;
        }

        .wish-thumb-container {
            width: 100%; height: 75%; display: flex; align-items: center;
            justify-content: center; overflow: hidden; position: relative;
            -webkit-touch-callout: none;
        }

        .wish-thumb { width: 100%; height: 100%; object-fit: contain; background: #fffcfc; pointer-events: none; }

        .wish-tag-badge {
            position: absolute; top: 4px; left: 4px; background: rgba(229, 152, 155, 0.9);
            color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px;
            max-width: 80%; overflow: hidden; text-overflow: ellipsis;
        }
        .wish-date-label, .wish-price-label {
            position: absolute; bottom: 4px; background: rgba(255,255,255,0.8);
            font-size: 9px; padding: 1px 4px; border-radius: 2px;
        }
        .wish-date-label { left: 4px; color: var(--text-main); }
        .wish-price-label { right: 4px; color: #e5989b; font-weight: bold; }

        .wish-title-area {
            width: 100%; padding: 4px 6px; font-size: 10px; line-height: 1.2;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            overflow: hidden; flex-grow: 1; pointer-events: none;
        }
        
        .del-btn {
            background: transparent; color: #eee; border: none; width: 44px; height: 44px;
            cursor: pointer; font-size: 18px; transition: all 0.2s;
            touch-action: manipulation;
        }
        #wish-list .del-btn {
            position: absolute; top: 0; right: 0; background: rgba(255, 255, 255, 0.8);
            width: 32px; height: 32px; /* 少し大きく */
            border-bottom-left-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            z-index: 2;
        }
        .del-btn:active { color: var(--delete-hover); background: rgba(255, 240, 240, 0.9); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--overlay-bg); display: none; justify-content: center;
            align-items: center; z-index: 1000; backdrop-filter: blur(4px);
        }
        .modal-content {
            background: var(--card-bg); width: 90%; max-width: 400px;
            padding: 25px; border-radius: 20px; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            -webkit-overflow-scrolling: touch;
        }
        .edit-form-group { margin-bottom: 15px; }
        .edit-form-group label { display: block; font-size: 11px; color: var(--text-sub); margin-bottom: 5px; }
        .edit-form-group input, .edit-form-group select {
            width: 100%; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; box-sizing: border-box;
            font-size: 16px; /* ズーム防止 */
        }
        .manage-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; border-bottom: 1px solid var(--border-color);
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>Favorite Collection</h2>
        <p class="label">キーワード/画像をタップで検索・長押しで編集</p>

        <div class="section-title">
            Quick Search
            <button class="add-btn sub" onclick="toggleModal('group-modal', true)">グループ編集</button>
        </div>
        
        <div class="input-group">
            <input type="text" id="keyword-input" placeholder="検索ワードを追加...">
            <button class="add-btn" onclick="addPanel()">追加</button>
        </div>
        <div class="input-controls" style="display:none">
            <select id="group-select"></select>
        </div>

        <div id="group-tabs-container" class="group-tabs"></div>
        <div id="panel-list-container"></div>

        <div class="section-title" id="wish-list-section">Wish List</div>
        <div class="input-group">
            <input type="text" id="wish-input" placeholder="商品のURLを貼り付け...">
            <button id="wish-save-btn" class="add-btn wish" onclick="addWishItem()">保存</button>
        </div>
        <div class="wish-controls" style="display:none">
            <select id="status-select">
                <option value="迷い中">迷い中</option>
                <option value="購入・予約済">購入・予約済</option>
                <option value="出たら買う">出たら買う</option>
                <option value="やめた">やめた</option>
            </select>
        </div>

        <div class="wish-tabs">
            <div class="wish-tab active" onclick="switchWishTab('迷い中')" id="tab-mayoi">
                <span>迷い中</span><span class="tab-badge" id="badge-mayoi">0</span>
            </div>
            <div class="wish-tab" onclick="switchWishTab('購入・予約済')" id="tab-bought">
                <span>購入・予約済</span><span class="tab-badge" id="badge-bought">0</span>
            </div>
            <div class="wish-tab" onclick="switchWishTab('出たら買う')" id="tab-future">
                <span>出たら買う</span><span class="tab-badge" id="badge-future">0</span>
            </div>
            <div class="wish-tab" onclick="switchWishTab('やめた')" id="tab-cancel">
                <span>やめた</span><span class="tab-badge" id="badge-cancel">0</span>
            </div>
        </div>

        <div id="filter-tags" class="filter-tags-container"></div>

        <div id="wish-list"></div>
    </div>

    <div id="group-modal" class="modal-overlay" onclick="toggleModal('group-modal', false)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="section-title" style="margin-top:0">グループ管理</div>
            <div id="modal-group-list" style="max-height:300px; overflow-y:auto; margin-bottom:20px;"></div>
            <div class="input-group">
                <input type="text" id="new-group-name" placeholder="新しいグループ名...">
                <button class="add-btn" onclick="addNewGroup()">追加</button>
            </div>
            <button class="add-btn sub" style="width:100%; margin-top:15px;" onclick="toggleModal('group-modal', false)">閉じる</button>
        </div>
    </div>

    <div id="status-modal" class="modal-overlay" onclick="toggleModal('status-modal', false)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="section-title" style="margin-top:0">アイテムの編集</div>
            <div class="edit-form-group">
                <label>タイトル</label>
                <input type="text" id="edit-wish-title">
            </div>
            <div class="edit-form-group">
                <label>ステータス</label>
                <select id="edit-wish-status">
                    <option value="迷い中">迷い中</option>
                    <option value="購入・予約済">購入・予約済</option>
                    <option value="出たら買う">出たら買う</option>
                    <option value="やめた">やめた</option>
                </select>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="edit-form-group" style="flex:1">
                    <label>発売日</label>
                    <input type="text" id="edit-wish-date" placeholder="2024/05">
                </div>
                <div class="edit-form-group" style="flex:1">
                    <label>価格</label>
                    <input type="text" id="edit-wish-price" placeholder="¥880">
                </div>
            </div>
            <div class="edit-form-group">
                <label>タグ (直接入力または下のチップを選択)</label>
                <input type="text" id="edit-wish-tag">
                <div id="modal-tag-chips" class="modal-tags-container" style="margin-top:8px;"></div>
            </div>
            <button class="add-btn" style="width:100%; padding:12px;" onclick="saveWishEdit()">保存する</button>
        </div>
    </div>

    <script>
        const CONFIG = {
            keys: {
                keywords: 'animate_search_keywords_v2',
                groups: 'animate_groups_v1',
                wish: 'animate_wish_list_v2'
            },
            urls: {
                animate: 'https://www.animate-onlineshop.jp/products/list.php?smt=',
                gamers: 'https://www.gamers.co.jp/products/list.php?smt='
            },
            longPressDuration: 600
        };

        let state = {
            currentWishTab: '迷い中',
            currentGroupTab: '未分類',
            currentWishTagFilter: null,
            currentSearchFilter: null, // ① 追加: 検索ワードによるフィルタ
            editingWishIndex: null,
            pressTimer: null,
            isLongPress: false,
            touchPos: { x: 0, y: 0 },
            isScrolling: false,
            isTouchDevice: false,
            preventNextClick: false // 追加: モーダル誤爆防止用フラグ
        };

        // --- Data Access Helpers ---
        const db = {
            get: (key, fallback) => JSON.parse(localStorage.getItem(key)) || fallback,
            set: (key, val) => localStorage.setItem(key, JSON.stringify(val)),
            
            getGroups: () => db.get(CONFIG.keys.groups, ["毎日", "ジャンル名", "今やってるやつ"]),
            getKeywords: () => {
                const data = db.get(CONFIG.keys.keywords, [{word: "クリアファイル", group: "未分類"}]);
                return data.map(k => typeof k === 'string' ? { word: k, group: "未分類" } : k);
            },
            getWishItems: () => db.get(CONFIG.keys.wish, [])
        };

        window.onload = () => { 
            window.addEventListener('touchstart', function() {
                state.isTouchDevice = true;
            }, {passive: true, once: true});
            refreshAll();
        };

        function refreshAll() {
            updateGroupSelect();
            renderPanels();
            renderWishItems();
        }

        function toggleModal(id, show) {
            document.getElementById(id).style.display = show ? 'flex' : 'none';
            if(id === 'group-modal' && show) renderModalGroups();
            if(id === 'status-modal' && show) renderModalTagChips();
        }

        // --- Group Management ---
        function updateGroupSelect() {
            const select = document.getElementById('group-select');
            const groups = ["未分類", ...db.getGroups()];
            select.innerHTML = groups.map(g => `<option value="${g}">${g}</option>`).join('');
        }

        function renderModalGroups() {
            const list = document.getElementById('modal-group-list');
            list.innerHTML = db.getGroups().map(g => `
                <div class="manage-item">
                    <span>${g}</span>
                    <span style="color:var(--delete-hover);cursor:pointer" onclick="removeGroup('${g}')">削除</span>
                </div>
            `).join('');
        }

        function addNewGroup() {
            const input = document.getElementById('new-group-name');
            const name = input.value.trim();
            const groups = db.getGroups();
            if (name && !groups.includes(name)) {
                groups.push(name);
                db.set(CONFIG.keys.groups, groups);
                input.value = '';
                updateGroupSelect();
                renderModalGroups();
                renderPanels();
            }
        }

        function removeGroup(name) {
            if (!confirm(`グループ「${name}」を削除しますか？\n中のアイテムは「未分類」になります`)) return;
            const groups = db.getGroups().filter(g => g !== name);
            const keywords = db.getKeywords().map(k => {
                if(k.group === name) k.group = "未分類";
                return k;
            });
            db.set(CONFIG.keys.groups, groups);
            db.set(CONFIG.keys.keywords, keywords);
            if (state.currentGroupTab === name) state.currentGroupTab = '未分類';
            refreshAll();
            renderModalGroups();
        }

        // --- Search Panels ---
        function renderPanels() {
            const tabs = document.getElementById('group-tabs-container');
            const container = document.getElementById('panel-list-container');
            const keywords = db.getKeywords();
            const allGroups = ["未分類", ...db.getGroups()];

            tabs.innerHTML = allGroups.map(g => {
                const count = keywords.filter(k => (k.group || "未分類") === g).length;
                if (count === 0 && g === "未分類") return '';
                return `
                    <div class="group-tab ${state.currentGroupTab === g ? 'active' : ''}" onclick="state.currentGroupTab='${g}';renderPanels()">
                        <span>${g}</span><span class="tab-badge">${count}</span>
                    </div>
                `;
            }).join('');

            const filtered = keywords.filter(k => (k.group || "未分類") === state.currentGroupTab);
            if (filtered.length === 0) {
                container.innerHTML = `<p style="text-align:center;color:var(--text-sub);font-size:0.8rem">なし</p>`;
                return;
            }

            container.innerHTML = `<div class="panel-list">${filtered.map(item => {
                const idx = keywords.indexOf(item);
                const enc = encodeURIComponent(item.word);
                const isActive = state.currentSearchFilter === item.word;
                return `
                    <div class="panel-item ${isActive ? 'active' : ''}" oncontextmenu="return false;" style="${isActive ? 'border-color:var(--accent-color); background:var(--primary-bg);' : ''}">
                        <div class="keyword-display" 
                             onmousedown="if(!state.isTouchDevice) handlePressStart(event, ${idx}, 'panel')" 
                             onmouseup="if(!state.isTouchDevice) handlePressEnd(event, ${idx}, 'panel')" 
                             ontouchstart="handlePressStart(event, ${idx}, 'panel')" 
                             ontouchmove="handleTouchMove(event)"
                             ontouchend="handlePressEnd(event, ${idx}, 'panel')"
                             ontouchcancel="handleTouchCancel()"
                             >${item.word}</div>
                        <a href="${CONFIG.urls.animate}${enc}" target="_blank" class="shop-btn"><span class="color-dot dot-animate"></span></a>
                        <a href="${CONFIG.urls.gamers}${enc}" target="_blank" class="shop-btn"><span class="color-dot dot-gamers"></span></a>
                    </div>
                `;
            }).join('')}</div>`;
        }

        function addPanel() {
            const word = document.getElementById('keyword-input').value.trim();
            const group = state.currentGroupTab;
            if (!word) return;
            const keywords = db.getKeywords();
            keywords.unshift({ word, group });
            db.set(CONFIG.keys.keywords, keywords);
            document.getElementById('keyword-input').value = '';
            renderPanels();
        }

        // --- Wish List ---
        function switchWishTab(s) {
            state.currentWishTab = s;
            // タグ絞り込みは解除せず、引き継ぐように修正
            document.querySelectorAll('.wish-tab').forEach(t => {
                t.classList.toggle('active', t.innerText.includes(s));
            });
            renderWishItems();
        }

        function toggleTagFilter(tag) {
            state.currentWishTagFilter = (state.currentWishTagFilter === tag) ? null : tag;
            renderWishItems(); // タブ件数も変わるため true（デフォルト）
        }

        // ② & ③ 追加: キーワード絞り込みとスクロール
        function applyKeywordFilter(word) {
            state.currentSearchFilter = (state.currentSearchFilter === word) ? null : word;
            renderPanels(); // パネル側の見た目も更新
            renderWishItems();
            
            // スクロール処理
            const section = document.getElementById('wish-list-section');
            if(section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function renderWishItems() {
            const list = document.getElementById('wish-list');
            const tagContainer = document.getElementById('filter-tags');
            const all = db.getWishItems();
            
            // ① 検索ワードフィルタリングのロジック追加
            const matchesSearch = (item) => {
                if (!state.currentSearchFilter) return true;
                const searchLower = state.currentSearchFilter.toLowerCase();
                return (item.title && item.title.toLowerCase().includes(searchLower)) || 
                       (item.tags && item.tags.toLowerCase().includes(searchLower));
            };

            // バッジの計算：タグ絞り込み + 検索フィルタがある場合は、その条件に合うものだけを各タブでカウント
            const counts = { '迷い中': 0, '購入・予約済': 0, '出たら買う': 0, 'やめた': 0 };
            all.forEach(item => {
                const status = item.status || '迷い中';
                const tagMatch = !state.currentWishTagFilter || item.tags === state.currentWishTagFilter;
                const searchMatch = matchesSearch(item);
                if (tagMatch && searchMatch) {
                    counts[status]++;
                }
            });
            Object.keys(counts).forEach(k => {
                const badgeId = { '迷い中':'badge-mayoi', '購入・予約済':'badge-bought', '出たら買う':'badge-future', 'やめた':'badge-cancel' }[k];
                document.getElementById(badgeId).textContent = counts[k];
            });

            // 表示するアイテムのフィルタリング
            let filtered = all.filter(item => (item.status || '迷い中') === state.currentWishTab);

            // 全体のタグリスト取得（チップ表示用。絞り込みに関係なく全アイテムからユニークなタグを抽出）
            const availableTags = [...new Set(all.map(item => item.tags).filter(t => t && t.trim() !== ""))];
            if (availableTags.length > 0) {
                tagContainer.innerHTML = `
                    <div class="tag-chip ${!state.currentWishTagFilter ? 'active' : ''}" onclick="toggleTagFilter(null)">すべて</div>
                    ${availableTags.map(tag => `
                        <div class="tag-chip ${state.currentWishTagFilter === tag ? 'active' : ''}" onclick="toggleTagFilter('${tag}')">${tag}</div>
                    `).join('')}
                `;
            } else {
                tagContainer.innerHTML = '';
            }

            // 実際の表示フィルタリングにタグ条件と検索条件を適用
            if (state.currentWishTagFilter) {
                filtered = filtered.filter(item => item.tags === state.currentWishTagFilter);
            }
            filtered = filtered.filter(matchesSearch);

            // 検索中ラベルの表示
            if (state.currentSearchFilter) {
                const searchLabel = `<div style="font-size:12px; color:var(--accent-color); margin-bottom:10px; padding:0 5px;">ワード: 「${state.currentSearchFilter}」で絞り込み中 <span style="text-decoration:underline; cursor:pointer;" onclick="applyKeywordFilter(null)">(解除)</span></div>`;
                list.innerHTML = searchLabel;
            } else {
                list.innerHTML = '';
            }

            if (filtered.length === 0) {
                list.innerHTML += `<p style="text-align:center;color:var(--text-sub);font-size:0.8rem;width:100%;margin-top:20px;">条件に合うアイテムがありません</p>`;
                return;
            }

            list.innerHTML += filtered.map(item => {
                const idx = all.indexOf(item);
                const domain = new URL(item.url).hostname;
                const fav = `https://www.google.com/s2/favicons?sz=128&domain=${domain}`;
                return `
                    <div class="panel-item" oncontextmenu="false;">
                        <a class="wish-thumb-container" href="${item.url}" target="_blank" 
                           onclick="if(state.isLongPress || state.preventNextClick){event.preventDefault();return false;}"
                           onmousedown="if(!state.isTouchDevice) handlePressStart(event, ${idx}, 'wish')" 
                           onmouseup="if(!state.isTouchDevice) handlePressEnd(event, ${idx}, 'wish')" 
                           ontouchstart="handlePressStart(event, ${idx}, 'wish')" 
                           ontouchmove="handleTouchMove(event)"
                           ontouchend="handlePressEnd(event, ${idx}, 'wish')" 
                           ontouchcancel="handleTouchCancel()">
                            <img src="${item.image || fav}" class="wish-thumb" onerror="this.src='${fav}'">
                            ${item.tags ? `<div class="wish-tag-badge">${item.tags}</div>` : ''}
                            ${item.releaseDate ? `<div class="wish-date-label">${item.releaseDate}</div>` : ''}
                            ${item.price ? `<div class="wish-price-label">${item.price}</div>` : ''}
                        </a>
                        <div class="wish-title-area">${item.title || '無題'}</div>
                        <button class="del-btn" onclick="event.stopPropagation(); deleteWishItem(${idx})">×</button>
                    </div>
                `;
            }).join('');
        }

        async function addWishItem() {
            const input = document.getElementById('wish-input');
            const btn = document.getElementById('wish-save-btn');
            const url = input.value.trim();
            if (!url.startsWith('http')) return;

            btn.disabled = true;
            btn.innerText = "...";
            
            let newItem = { url, title: "URLのみ保存", image: null, status: state.currentWishTab, releaseDate: "", price: "", tags: "" };
            
            try {
                const res = await fetch(`https://api.microlink.io?url=${encodeURIComponent(url)}`);
                const json = await res.json();
                if(json.data) {
                    newItem.title = json.data.title || newItem.title;
                    newItem.image = json.data.image ? json.data.image.url : null;
                }
            } catch (e) { console.error("Fetch failed"); }

            const items = db.getWishItems();
            items.unshift(newItem);
            db.set(CONFIG.keys.wish, items);
            input.value = '';
            btn.disabled = false;
            btn.innerText = "保存";
            switchWishTab(newItem.status);
        }

        function deleteWishItem(idx) {
            if(!confirm("削除しますか？")) return;
            const items = db.getWishItems();
            items.splice(idx, 1);
            db.set(CONFIG.keys.wish, items);
            renderWishItems();
        }

        // --- Modal Edit Actions ---
        function renderModalTagChips() {
            const container = document.getElementById('modal-tag-chips');
            const allItems = db.getWishItems();
            const uniqueTags = [...new Set(allItems.map(i => i.tags).filter(t => t && t.trim() !== ""))];
            
            if (uniqueTags.length === 0) {
                container.innerHTML = '<span style="font-size:10px;color:var(--text-sub)">登録済みのタグはありません</span>';
                return;
            }
            
            container.innerHTML = uniqueTags.map(tag => `
                <div class="modal-tag-chip" onclick="setEditTag('${tag}')">${tag}</div>
            `).join('');
        }

        function setEditTag(tag) {
            document.getElementById('edit-wish-tag').value = tag;
        }

        function saveWishEdit() {
            const items = db.getWishItems();
            const item = items[state.editingWishIndex];
            item.title = document.getElementById('edit-wish-title').value;
            item.status = document.getElementById('edit-wish-status').value;
            item.releaseDate = document.getElementById('edit-wish-date').value;
            item.price = document.getElementById('edit-wish-price').value;
            item.tags = document.getElementById('edit-wish-tag').value.trim();
            db.set(CONFIG.keys.wish, items);
            toggleModal('status-modal', false);
            renderWishItems();
        }

        // --- Improved Logic for Touch/Long Press ---
        function handlePressStart(e, idx, type) {
            state.isLongPress = false;
            state.isScrolling = false;
            state.preventNextClick = false; // 初期化
            
            if (e.touches) {
                state.touchPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            } else {
                state.touchPos = { x: e.clientX, y: e.clientY };
            }

            state.pressTimer = setTimeout(() => {
                if (!state.isScrolling) {
                    state.isLongPress = true;
                    state.preventNextClick = true; // 指を離すまでクリックイベントを阻止
                    
                    if (navigator.vibrate) navigator.vibrate(50);
                    
                    if (type === 'panel') {
                        handlePanelEdit(idx);
                    } else {
                        // ウィッシュリスト: 長押しで詳細編集
                        state.editingWishIndex = idx;
                        const item = db.getWishItems()[idx];
                        document.getElementById('edit-wish-title').value = item.title || "";
                        document.getElementById('edit-wish-status').value = item.status || "迷い中";
                        document.getElementById('edit-wish-date').value = item.releaseDate || "";
                        document.getElementById('edit-wish-price').value = item.price || "";
                        document.getElementById('edit-wish-tag').value = item.tags || "";
                        
                        // モーダル表示を少し遅らせて、表示直後の誤タップを物理的に防ぐ
                        setTimeout(() => toggleModal('status-modal', true), 50);
                    }
                }
            }, CONFIG.longPressDuration);
        }

        function handleTouchMove(e) {
            if (!state.touchPos) return;
            const move = Math.hypot(
                e.touches[0].clientX - state.touchPos.x, 
                e.touches[0].clientY - state.touchPos.y
            );
            if (move > 10) {
                state.isScrolling = true;
                clearTimeout(state.pressTimer);
            }
        }

        function handleTouchCancel() {
            clearTimeout(state.pressTimer);
            state.isScrolling = false;
        }

        function handlePressEnd(e, idx, type) {
            clearTimeout(state.pressTimer);
            
            // 指を離した瞬間にフラグを解除するが、このイベント自体の伝播は防ぐ
            if (state.isLongPress) {
                if(e.cancelable) e.preventDefault();
                // 離した瞬間にフラグを落とすと直後のclickイベントが走る場合があるため、僅かにディレイ
                setTimeout(() => { 
                    state.isLongPress = false;
                    state.preventNextClick = false;
                }, 100);
                return;
            }

            if (state.isScrolling) return;

            // ② タップ動作の書き換え: アニメイトを開く代わりに絞り込みを呼び出す
            if (type === 'panel') {
                const item = db.getKeywords()[idx];
                applyKeywordFilter(item.word);
            }
        }

        function handlePanelEdit(idx) {
            const keywords = db.getKeywords();
            const currentWord = keywords[idx].word;
            
            const newWord = prompt("キーワードを編集\n(空欄にしてOKを押すと削除されます)", currentWord);
            
            if (newWord === null) {
                state.isLongPress = false;
                state.preventNextClick = false;
                return; 
            }

            if (newWord.trim() === "") {
                if(confirm(`「${currentWord}」を削除しますか？`)) {
                    keywords.splice(idx, 1);
                    db.set(CONFIG.keys.keywords, keywords);
                    renderPanels();
                }
            } else if (newWord !== currentWord) {
                keywords[idx].word = newWord;
                db.set(CONFIG.keys.keywords, keywords);
                renderPanels();
            }
            state.isLongPress = false;
            state.preventNextClick = false;
        }

        document.getElementById('keyword-input').onkeypress = (e) => e.key === 'Enter' && addPanel();
        document.getElementById('wish-input').onkeypress = (e) => e.key === 'Enter' && addWishItem();
    </script>
</body>
</html>
